version: '2.3'

services:
  prosody:
    container_name: prosody_trunk
    build: .
    restart: unless-stopped
    networks:
      net:
        ipv6_address: 2a01:4f8:1c17:42a2:dead:c01d:1d13:f001
    ports:
      # socks5 bytestream proxy
      - 5000:5000/tcp
      # c2s
      - 5222:5222/tcp
      # s2s
      - 5269:5269/tcp
      # bosch (reverse proxied)
      - 127.0.0.1:5280:5280/tcp
    expose:
      # component
      - 5347/tcp
      # bosch TLS (not forwarded)
      - 5281/tcp
    extra_hosts:
      - "db:172.17.0.1"
    dns:
      # the host's resolv.conf is linked to
      # /run/systemd/resolve/stub-resolv.conf
      # which only containts a loopback address
      # which again is filtered by docker because
      # it's unreachable from insode the container
      - 213.133.98.98
      - 2a01:4f8:0:a0a1::add:1010
      - 213.133.99.99
      - 2a01:4f8:0:a102::add:9999
      - 213.133.100.100
      - 2a01:4f8:0:a111::add:9898
    environment:
      - TZ=Europe/Berlin
      - USER=prosody
      - UID=977
      - GID=977
    volumes:
      # bind mounts ro
      - /etc/localtime:/etc/localtime:ro
      - /run/postgresql:/run/postgresql:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      # bind mounts rw
      - /home/prosody/config:/etc/prosody
      - /home/prosody/data:/var/lib/prosody
      - /home/prosody/upload:/var/lib/prosody/upload
      # docker volumes
      - logs:/var/log/prosody
      - src:/usr/src/prosody
      - modules:/usr/lib/prosody/modules

networks:
  net:
    driver: bridge
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: 2a01:4f8:1c17:42a2:dead::/80
          gateway: 2a01:4f8:1c17:42a2:dead::1

volumes:
  logs:
  src:
  modules:

